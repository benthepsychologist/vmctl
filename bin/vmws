#!/bin/bash
# VM Workstation Manager CLI
# Manages self-hosted development VMs as Cloud Workstation replacements

set -e

VERSION="1.0.0"
CONFIG_FILE="${HOME}/.vmws/config"

# Default configuration
DEFAULT_VM_NAME="dev-workstation"
DEFAULT_ZONE="us-central1-a"
DEFAULT_PROJECT=""

# Load configuration
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi
    VM_NAME="${VM_NAME:-$DEFAULT_VM_NAME}"
    ZONE="${ZONE:-$DEFAULT_ZONE}"
    PROJECT="${PROJECT:-$(gcloud config get-value project 2>/dev/null)}"
}

# Save configuration
save_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"
    cat > "$CONFIG_FILE" <<EOF
VM_NAME="$VM_NAME"
ZONE="$ZONE"
PROJECT="$PROJECT"
EOF
}

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat <<EOF
VM Workstation Manager v${VERSION}

Usage: vmws <command> [options]

Commands:
  create              Create a new development VM from workstation snapshot
  start               Start the VM if stopped
  stop                Stop the VM
  connect             Connect to VM via SSH
  tunnel              Start IAP tunnel to code-server
  status              Show VM status
  delete              Delete the VM and all resources
  config              Configure VM name, zone, and project
  ssh                 SSH into the VM
  logs                View auto-shutdown logs

  install             Install vmws on local machine (Mac/Linux)

Options:
  -h, --help          Show this help message
  -v, --version       Show version

Examples:
  vmws create         # Create new dev VM from workstation
  vmws start          # Start stopped VM
  vmws connect        # SSH into VM
  vmws tunnel         # Open tunnel to code-server (port 8080)
  vmws status         # Check if VM is running
  vmws stop           # Stop VM to save money
  vmws delete         # Delete everything

Configuration:
  Config file: ~/.vmws/config

  Set defaults:
    vmws config --vm-name my-dev-vm --zone us-central1-a

Cost Savings:
  Cloud Workstation:  \$150/month
  Self-managed VM:    \$26-59/month
  Savings:            \$91-124/month (61-83%)

For more info: https://github.com/yourusername/vm-workstation-manager
EOF
}

check_vm_exists() {
    gcloud compute instances describe "$VM_NAME" --zone="$ZONE" --project="$PROJECT" &>/dev/null
}

get_vm_status() {
    if ! check_vm_exists; then
        echo "DOES_NOT_EXIST"
        return
    fi
    gcloud compute instances describe "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --format="value(status)" 2>/dev/null || echo "UNKNOWN"
}

cmd_create() {
    echo -e "${YELLOW}Creating development VM...${NC}"
    echo ""

    # Check if we're on a workstation
    if [ ! -f "/home/user/run-vm-test-workflow.sh" ]; then
        echo -e "${RED}Error: Must run 'vmws create' from Cloud Workstation${NC}"
        echo "This command creates a VM from your workstation's disk snapshot."
        exit 1
    fi

    bash /home/user/run-vm-test-workflow.sh
}

cmd_start() {
    echo -e "${YELLOW}Starting VM: $VM_NAME${NC}"

    STATUS=$(get_vm_status)

    if [ "$STATUS" = "DOES_NOT_EXIST" ]; then
        echo -e "${RED}Error: VM does not exist${NC}"
        echo "Run: vmws create"
        exit 1
    fi

    if [ "$STATUS" = "RUNNING" ]; then
        echo -e "${GREEN}✓ VM is already running${NC}"
        return
    fi

    echo "Starting VM..."
    gcloud compute instances start "$VM_NAME" --zone="$ZONE" --project="$PROJECT"

    echo "Waiting for VM to be ready..."
    sleep 10

    for i in {1..30}; do
        if gcloud compute ssh "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --tunnel-through-iap --command="echo ready" &>/dev/null; then
            echo -e "${GREEN}✓ VM is ready!${NC}"
            echo ""
            echo "To access code-server: vmws tunnel"
            echo "To SSH: vmws connect"
            return
        fi
        sleep 2
    done

    echo -e "${RED}Warning: VM started but SSH not ready yet${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}Stopping VM: $VM_NAME${NC}"

    STATUS=$(get_vm_status)

    if [ "$STATUS" = "DOES_NOT_EXIST" ]; then
        echo -e "${RED}Error: VM does not exist${NC}"
        exit 1
    fi

    if [ "$STATUS" = "TERMINATED" ]; then
        echo -e "${GREEN}✓ VM is already stopped${NC}"
        return
    fi

    gcloud compute instances stop "$VM_NAME" --zone="$ZONE" --project="$PROJECT"
    echo -e "${GREEN}✓ VM stopped${NC}"
}

cmd_status() {
    STATUS=$(get_vm_status)

    echo "VM Status Report"
    echo "================"
    echo "Name:    $VM_NAME"
    echo "Zone:    $ZONE"
    echo "Project: $PROJECT"
    echo ""

    case "$STATUS" in
        "RUNNING")
            echo -e "Status:  ${GREEN}RUNNING ✓${NC}"

            # Get IP
            IP=$(gcloud compute instances describe "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --format="value(networkInterfaces[0].accessConfigs[0].natIP)" 2>/dev/null)
            echo "IP:      $IP"
            echo ""
            echo "Access:"
            echo "  SSH:         vmws connect"
            echo "  Code-server: vmws tunnel (then visit http://localhost:8080)"
            ;;
        "TERMINATED")
            echo -e "Status:  ${YELLOW}STOPPED${NC}"
            echo ""
            echo "To start: vmws start"
            ;;
        "DOES_NOT_EXIST")
            echo -e "Status:  ${RED}DOES NOT EXIST${NC}"
            echo ""
            echo "To create: vmws create (from workstation)"
            ;;
        *)
            echo "Status:  $STATUS"
            ;;
    esac
}

cmd_connect() {
    STATUS=$(get_vm_status)

    if [ "$STATUS" != "RUNNING" ]; then
        echo -e "${RED}Error: VM is not running (status: $STATUS)${NC}"
        echo "Run: vmws start"
        exit 1
    fi

    echo -e "${GREEN}Connecting to VM...${NC}"
    gcloud compute ssh "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --tunnel-through-iap
}

cmd_tunnel() {
    STATUS=$(get_vm_status)

    if [ "$STATUS" != "RUNNING" ]; then
        echo -e "${RED}Error: VM is not running (status: $STATUS)${NC}"
        echo "Run: vmws start"
        exit 1
    fi

    echo -e "${GREEN}Starting IAP tunnel to code-server...${NC}"
    echo ""
    echo "Visit: ${BLUE}http://localhost:8080${NC}"
    echo "Press Ctrl+C to stop the tunnel"
    echo ""

    gcloud compute ssh "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --tunnel-through-iap -- -L 8080:localhost:8080 -N
}

cmd_ssh() {
    cmd_connect
}

cmd_delete() {
    echo -e "${YELLOW}Deleting VM and all resources${NC}"
    echo ""

    if ! check_vm_exists; then
        echo -e "${RED}VM does not exist${NC}"
        exit 1
    fi

    read -p "Are you sure you want to delete $VM_NAME? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        echo "Cancelled"
        exit 0
    fi

    # Check if we're on workstation with cleanup script
    if [ -f "/home/user/cleanup-test-vm.sh" ]; then
        bash /home/user/cleanup-test-vm.sh
    else
        # Manual cleanup
        echo "Deleting VM..."
        gcloud compute instances delete "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --quiet

        echo "Deleting disk..."
        gcloud compute disks delete "${VM_NAME}-disk" --zone="$ZONE" --project="$PROJECT" --quiet 2>/dev/null || true

        echo "Deleting snapshots..."
        gcloud compute snapshots list --filter="name~$VM_NAME" --format="value(name)" | while read snapshot; do
            gcloud compute snapshots delete "$snapshot" --quiet
        done
    fi

    echo -e "${GREEN}✓ Deleted${NC}"
}

cmd_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"

    if [ "$#" -eq 0 ]; then
        # Interactive configuration
        echo "Current Configuration:"
        echo "  VM Name: $VM_NAME"
        echo "  Zone:    $ZONE"
        echo "  Project: $PROJECT"
        echo ""

        read -p "VM Name [$VM_NAME]: " new_name
        read -p "Zone [$ZONE]: " new_zone
        read -p "Project [$PROJECT]: " new_project

        VM_NAME="${new_name:-$VM_NAME}"
        ZONE="${new_zone:-$ZONE}"
        PROJECT="${new_project:-$PROJECT}"

        save_config
        echo -e "${GREEN}✓ Configuration saved${NC}"
    else
        # Parse command line options
        while [[ $# -gt 0 ]]; do
            case $1 in
                --vm-name)
                    VM_NAME="$2"
                    shift 2
                    ;;
                --zone)
                    ZONE="$2"
                    shift 2
                    ;;
                --project)
                    PROJECT="$2"
                    shift 2
                    ;;
                *)
                    echo "Unknown option: $1"
                    exit 1
                    ;;
            esac
        done
        save_config
        echo -e "${GREEN}✓ Configuration saved${NC}"
    fi
}

cmd_logs() {
    if ! check_vm_exists; then
        echo -e "${RED}VM does not exist${NC}"
        exit 1
    fi

    echo "Auto-shutdown logs:"
    echo "==================="
    gcloud compute ssh "$VM_NAME" --zone="$ZONE" --project="$PROJECT" --tunnel-through-iap --command="sudo journalctl -u vm-auto-shutdown -n 50 --no-pager"
}

cmd_install() {
    echo "Installing vmws locally..."

    # Determine install location
    if [ -w "/usr/local/bin" ]; then
        INSTALL_DIR="/usr/local/bin"
    else
        INSTALL_DIR="$HOME/.local/bin"
        mkdir -p "$INSTALL_DIR"
    fi

    # Copy this script
    cp "$0" "$INSTALL_DIR/vmws"
    chmod +x "$INSTALL_DIR/vmws"

    echo -e "${GREEN}✓ Installed to $INSTALL_DIR/vmws${NC}"

    if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
        echo ""
        echo -e "${YELLOW}Note: Add $INSTALL_DIR to your PATH${NC}"
        echo "Add this to your ~/.bashrc or ~/.zshrc:"
        echo "  export PATH=\"\$PATH:$INSTALL_DIR\""
    fi
}

# Main command dispatcher
main() {
    load_config

    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi

    case "$1" in
        create)
            cmd_create
            ;;
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        status)
            cmd_status
            ;;
        connect|ssh)
            cmd_connect
            ;;
        tunnel)
            cmd_tunnel
            ;;
        delete)
            cmd_delete
            ;;
        config)
            shift
            cmd_config "$@"
            ;;
        logs)
            cmd_logs
            ;;
        install)
            cmd_install
            ;;
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            echo "vmws version $VERSION"
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"

# openclaw-gateway Agent Zone App
#
# Trust boundary: This container operates in the AGENT zone with strict isolation.
# - Agent CANNOT access /workspace or broader host filesystem
# - Agent CANNOT access Docker socket (no container escape)
# - Agent secrets are limited to explicitly granted channel tokens
#
# Life/dev zones CAN access this app's directories for review/ops/recovery.

services:
  openclaw:
    image: openclaw-gateway:agent
    build:
      context: /srv/vmctl/agent/openclaw-gateway/repo
    container_name: openclaw-gateway
    hostname: openclaw

    # Strict mount allowlist - agent sees ONLY these paths
    volumes:
      # Code checkout (read-only)
      - /srv/vmctl/agent/openclaw-gateway/repo:/app:ro
      # Artifact outbox (read-write) - cross-zone channel
      - /srv/vmctl/agent/openclaw-gateway/outbox:/outbox:rw
      # Runtime state (read-write) - sqlite, caches, queues
      - /srv/vmctl/agent/openclaw-gateway/state:/state:rw

    # Load only explicitly granted tokens
    env_file:
      - /srv/vmctl/agent/openclaw-gateway/secrets/agent.env

    environment:
      - ZONE=agent
      - TRUST_LEVEL=restricted
      - OPENCLAW_STATE_DIR=/state

    # Security hardening (permissive enough for plugins/state mutation)
    # read_only removed: openclaw needs to write to /state and /tmp for plugins, cache, state files
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Writable tmp for runtime needs
    tmpfs:
      - /tmp:mode=1777,size=100m

    restart: unless-stopped

    networks:
      - agent

networks:
  agent:
    driver: bridge
    # Note: NOT internal - agent needs outbound access to channel APIs.
    # Inbound access is blocked by not exposing ports

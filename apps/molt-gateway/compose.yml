# molt-gateway Agent Zone App
#
# Trust boundary: This container operates in the AGENT zone with strict isolation.
# - Agent CANNOT access /workspace or broader host filesystem
# - Agent CANNOT access Docker socket (no container escape)
# - Agent secrets are limited to explicitly granted channel tokens
#
# Life/dev zones CAN access this app's directories for review/ops/recovery.

services:
  molt:
    image: molt-gateway:agent
    build:
      context: /srv/vmctl/agent/molt-gateway/repo
    container_name: molt-gateway
    hostname: molt

    # Strict mount allowlist - agent sees ONLY these paths
    volumes:
      # Code checkout (read-only)
      - /srv/vmctl/agent/molt-gateway/repo:/app:ro
      # Artifact outbox (read-write) - cross-zone channel
      - /srv/vmctl/agent/molt-gateway/outbox:/outbox:rw
      # Runtime state (read-write) - sqlite, caches, queues
      - /srv/vmctl/agent/molt-gateway/state:/state:rw

    # Load only explicitly granted tokens
    env_file:
      - /srv/vmctl/agent/molt-gateway/secrets/agent.env

    environment:
      - ZONE=agent
      - TRUST_LEVEL=restricted

    # Security hardening
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Writable tmp for runtime needs
    tmpfs:
      - /tmp:mode=1777,size=100m

    restart: unless-stopped

    networks:
      - agent

networks:
  agent:
    driver: bridge
    # Note: NOT internal - agent needs outbound access to channel APIs.
    # Inbound access is blocked by not exposing ports
